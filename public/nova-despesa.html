<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Nova Despesa - Sistema de Despesas</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’° Nova Despesa</h1>
            <div class="user-info">
                <span class="user-name" id="nomeUsuario"></span>
                <button class="btn-logout" id="btnLogout">Sair</button>
            </div>
        </div>

        <div class="despesas-container">
            <div id="alertBox" class="alert"></div>

            <form id="formDespesa">
                <div class="form-group">
                    <label for="valor">Valor (R$) *</label>
                    <input type="number" id="valor" name="valor" step="0.01" min="0.01" 
                           inputmode="decimal" pattern="[0-9]*" required 
                           placeholder="0,00" autofocus>
                </div>

                <div class="form-group">
                    <label for="descricao">DescriÃ§Ã£o *</label>
                    <input type="text" id="descricao" name="descricao" required 
                           placeholder="Ex: Conta de luz">
                </div>

                <div class="form-group">
                    <label for="categoria_id">Categoria *</label>
                    <select id="categoria_id" name="categoria_id" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo *</label>
                    <select id="tipo" name="tipo" required>
                        <option value="variavel">VariÃ¡vel</option>
                        <option value="fixa">Fixa (todo mÃªs)</option>
                        <option value="parcelada">Parcelada</option>
                    </select>
                </div>

                <div class="form-group" id="parcelasGroup" style="display: none;">
                    <label for="total_parcelas">NÃºmero de Parcelas *</label>
                    <input type="number" id="total_parcelas" name="total_parcelas" 
                           min="2" max="60" inputmode="numeric" pattern="[0-9]*"
                           placeholder="Ex: 12">
                </div>

                <div class="form-group">
                    <label for="data_vencimento">Vencimento *</label>
                    <input type="date" id="data_vencimento" name="data_vencimento" required>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="dividir" name="dividir">
                    <label for="dividir">Dividir despesa (Ã·2)</label>
                </div>

                <div id="compartilhadoGroup" style="display: none;">
                    <div class="form-group">
                        <label for="usuario_compartilhado_id">Com quem?</label>
                        <select id="usuario_compartilhado_id" name="usuario_compartilhado_id">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">âœ“ Salvar Despesa</button>
                    <a href="/dashboard.html" class="btn btn-secondary">âœ• Cancelar</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function verificarSessao() {
            try {
                const response = await fetch('/api/auth/verificar-sessao');
                const data = await response.json();

                if (!data.autenticado) {
                    window.location.href = '/login.html';
                    return false;
                }

                document.getElementById('nomeUsuario').textContent = data.usuario.nome;
                return true;
            } catch (erro) {
                window.location.href = '/login.html';
                return false;
            }
        }

        async function carregarCategorias() {
            try {
                const response = await fetch('/api/despesas/categorias');
                const categorias = await response.json();

                const select = document.getElementById('categoria_id');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    select.appendChild(option);
                });
            } catch (erro) {
                console.error('Erro ao carregar categorias:', erro);
            }
        }

        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/despesas/usuarios');
                const usuarios = await response.json();

                const select = document.getElementById('usuario_compartilhado_id');
                usuarios.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.nome;
                    select.appendChild(option);
                });
            } catch (erro) {
                console.error('Erro ao carregar usuÃ¡rios:', erro);
            }
        }

        function mostrarAlerta(mensagem, tipo = 'error') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = mensagem;
            alertBox.className = `alert alert-${tipo}`;
            alertBox.style.display = 'block';
            
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        document.getElementById('tipo').addEventListener('change', (e) => {
            const parcelasGroup = document.getElementById('parcelasGroup');
            if (e.target.value === 'parcelada') {
                parcelasGroup.style.display = 'block';
                document.getElementById('total_parcelas').required = true;
            } else {
                parcelasGroup.style.display = 'none';
                document.getElementById('total_parcelas').required = false;
            }
        });

        document.getElementById('dividir').addEventListener('change', (e) => {
            const compartilhadoGroup = document.getElementById('compartilhadoGroup');
            const usuarioSelect = document.getElementById('usuario_compartilhado_id');

            if (e.target.checked) {
                compartilhadoGroup.style.display = 'block';
                usuarioSelect.required = true;

                // Tenta selecionar automaticamente o primeiro usuÃ¡rio disponÃ­vel
                setTimeout(() => {
                    if (usuarioSelect.options.length > 1) { // Mais de uma opÃ§Ã£o (excluindo o placeholder)
                        usuarioSelect.selectedIndex = 1; // Seleciona o primeiro usuÃ¡rio real
                    }
                }, 0);
            } else {
                compartilhadoGroup.style.display = 'none';
                usuarioSelect.required = false;
            }
        });

        document.getElementById('data_vencimento').valueAsDate = new Date();

        document.getElementById('formDespesa').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                descricao: document.getElementById('descricao').value,
                valor: document.getElementById('valor').value,
                categoria_id: document.getElementById('categoria_id').value,
                tipo: document.getElementById('tipo').value,
                data_vencimento: document.getElementById('data_vencimento').value,
                total_parcelas: document.getElementById('total_parcelas').value || null,
                dividir: document.getElementById('dividir').checked,
                usuario_compartilhado_id: document.getElementById('usuario_compartilhado_id').value || null
            };

            try {
                const response = await fetch('/api/despesas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarAlerta('âœ“ ' + data.mensagem, 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1500);
                } else {
                    mostrarAlerta(data.erro || 'Erro ao cadastrar');
                }
            } catch (erro) {
                console.error('Erro:', erro);
                mostrarAlerta('Erro ao conectar com o servidor');
            }
        });

        document.getElementById('btnLogout').addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
            }
        });

        async function inicializar() {
            const autenticado = await verificarSessao();
            if (autenticado) {
                await carregarCategorias();
                await carregarUsuarios();
                
                // Focar no campo de valor apÃ³s carregar
                setTimeout(() => {
                    document.getElementById('valor').focus();
                }, 100);
            }
        }

        inicializar();
    </script>
    <script src="/js/particles.js"></script>
    <script src="/js/prevenir-zoom.js"></script>
</body>
</html>