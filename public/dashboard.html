<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dashboard - Sistema de Despesas</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Minhas Despesas</h1>
            <div class="user-info">
                <span class="user-name" id="nomeUsuario"></span>
                <button class="btn-logout" id="btnLogout">Sair</button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card total">
                <h3>Total</h3>
                <div class="value" id="totalMes">R$ 0</div>
            </div>
            <div class="stat-card pagas">
                <h3>Pagas</h3>
                <div class="value" id="totalPagas">R$ 0</div>
            </div>
            <div class="stat-card pendentes">
                <h3>Pendentes</h3>
                <div class="value" id="totalPendentes">R$ 0</div>
            </div>
        </div>

        <div class="month-navigation">
            <button class="btn-nav" id="btnMesAnterior">‚Üê</button>
            <div class="month-display" id="mesAnoDisplay">Dezembro 2024</div>
            <button class="btn-nav" id="btnMesProximo">‚Üí</button>
        </div>

        <div class="despesas-container">
            <div id="listaDespesas">
                <div class="loading">Carregando</div>
            </div>
        </div>

        <!-- Bot√£o Flutuante -->
        <a href="/nova-despesa.html" class="fab">+</a>
    </div>

    <script>
        let usuarioAtual = null;
        let mesAtual = new Date().getMonth() + 1;
        let anoAtual = new Date().getFullYear();

        const mesesNomes = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        async function verificarSessao() {
            try {
                const response = await fetch('/api/auth/verificar-sessao');
                const data = await response.json();

                if (!data.autenticado) {
                    window.location.href = '/login.html';
                    return false;
                }

                usuarioAtual = data.usuario;
                document.getElementById('nomeUsuario').textContent = data.usuario.nome;
                return true;
            } catch (erro) {
                window.location.href = '/login.html';
                return false;
            }
        }

        function atualizarDisplay() {
            document.getElementById('mesAnoDisplay').textContent =
                `${mesesNomes[mesAtual - 1]} ${anoAtual}`;
        }

        function mesAnterior() {
            mesAtual--;
            if (mesAtual < 1) {
                mesAtual = 12;
                anoAtual--;
            }
            atualizarDisplay();
            carregarDespesas();
        }

        function mesProximo() {
            mesAtual++;
            if (mesAtual > 12) {
                mesAtual = 1;
                anoAtual++;
            }
            atualizarDisplay();
            carregarDespesas();
        }

        async function carregarDespesas() {
            try {
                const response = await fetch(`/api/despesas?mes=${mesAtual}&ano=${anoAtual}`);
                const despesas = await response.json();

                exibirDespesas(despesas);
                calcularTotais(despesas);
            } catch (erro) {
                console.error('Erro ao carregar despesas:', erro);
                document.getElementById('listaDespesas').innerHTML =
                    '<div class="empty-state">‚ùå Erro ao carregar</div>';
            }
        }

        function exibirDespesas(despesas) {
            const container = document.getElementById('listaDespesas');

            if (despesas.length === 0) {
                container.innerHTML =
                    '<div class="empty-state">‚ú® Nenhuma despesa</div>';
                return;
            }

            container.innerHTML = despesas.map(despesa => {
                console.log('Data vencimento:', despesa.data_vencimento); // Debug

                // Tratar a data corretamente
                let data;
                if (despesa.data_vencimento) {
                    // Se vier como "2024-12-13T00:00:00.000Z" ou "2024-12-13"
                    data = new Date(despesa.data_vencimento);

                    // Se a data for inv√°lida, tentar outro formato
                    if (isNaN(data.getTime())) {
                        data = new Date(despesa.data_vencimento + 'T00:00:00');
                    }
                } else {
                    data = new Date();
                }

                const dia = data.getDate().toString().padStart(2, '0');
                const mes = (data.getMonth() + 1).toString().padStart(2, '0');

                // Converter valor para n√∫mero
                const valor = parseFloat(despesa.valor) || 0;

                let detalhes = `<span class="categoria-badge" style="background-color: ${despesa.categoria_cor}">${despesa.categoria_nome}</span>`;
                detalhes += ` <span>${dia}/${mes}</span>`;

                if (despesa.tipo === 'fixa') {
                    detalhes += ` ‚Ä¢ Fixa`;
                }

                if (despesa.dividida) {
                    detalhes += ` ‚Ä¢ √∑2`;
                }

                return `
                    <div class="despesa-item ${despesa.paga ? 'paga' : ''}">
                        <input type="checkbox" class="checkbox-paga" 
                               ${despesa.paga ? 'checked' : ''} 
                               onchange="window.alterarStatusPagamento(${despesa.id}, this.checked)">
                        <div class="despesa-info">
                            <div class="despesa-descricao">${despesa.descricao}</div>
                            <div class="despesa-detalhes">${detalhes}</div>
                        </div>
                        <div class="despesa-valor">R$ ${Math.round(valor)}</div>
                        <button class="btn-excluir" onclick="window.excluirDespesa('${despesa.id}')">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function calcularTotais(despesas) {
            const total = despesas.reduce((sum, d) => sum + parseFloat(d.valor), 0);
            const pagas = despesas.filter(d => d.paga).reduce((sum, d) => sum + parseFloat(d.valor), 0);
            const pendentes = total - pagas;

            document.getElementById('totalMes').textContent =
                `R$ ${Math.round(total)}`;
            document.getElementById('totalPagas').textContent =
                `R$ ${Math.round(pagas)}`;
            document.getElementById('totalPendentes').textContent =
                `R$ ${Math.round(pendentes)}`;
        }

        window.alterarStatusPagamento = async function (id, paga) {
            try {
                await fetch(`/api/despesas/${id}/pagar`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ paga })
                });

                carregarDespesas();
            } catch (erro) {
                console.error('Erro ao atualizar despesa:', erro);
                alert('Erro ao atualizar despesa');
            }
        };

        // Vari√°veis para controle de exclus√£o
        let despesaParaExcluir = null;

        // Fun√ß√£o para mostrar o modal de confirma√ß√£o
        function mostrarModalConfirmacao(mensagem, botoes, callback) {
            // Criar overlay escuro
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Criar conte√∫do do modal
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                max-width: 90%;
                width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;

            // Adicionar mensagem
            const mensagemElement = document.createElement('p');
            mensagemElement.textContent = mensagem;
            mensagemElement.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 16px;
                color: #333;
            `;

            // Criar bot√µes
            const botoesDiv = document.createElement('div');
            botoesDiv.style.cssText = `
                display: flex;
                justify-content: space-around;
                gap: 10px;
            `;

            // Adicionar bot√µes dinamicamente
            botoes.forEach(botao => {
                const btn = document.createElement('button');
                btn.textContent = botao.texto;
                btn.className = botao.classe;
                btn.style.cssText = `
                    background: ${botao.cor};
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    flex: 1;
                `;

                btn.addEventListener('click', () => {
                    callback(botao.valor);
                    document.body.removeChild(overlay);
                });

                botoesDiv.appendChild(btn);
            });

            // Adicionar elementos ao modal
            modalContent.appendChild(mensagemElement);
            modalContent.appendChild(botoesDiv);
            overlay.appendChild(modalContent);

            // Adicionar overlay ao body
            document.body.appendChild(overlay);
        }

        window.excluirDespesa = async function (id) {
            // Primeiro, obter informa√ß√µes da despesa para verificar se √© parcelada
            try {
                // Para despesas fixas, n√£o precisamos verificar parcelamento
                if (typeof id === 'string' && id.startsWith('fixa-')) {
                    mostrarModalConfirmacao('Excluir esta despesa fixa?', [
                        { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                        { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'excluir') {
                            excluirDoBackend(id);
                        }
                    });
                    return;
                }

                // Para despesas normais, verificar se √© parcelada
                const despesas = await obterDespesas(); // Obter lista atualizada
                const despesa = despesas.find(d => d.id == id);

                if (despesa && despesa.grupo_parcelamento && despesa.total_parcelas && despesa.total_parcelas > 1) {
                    // √â uma despesa parcelada
                    mostrarModalConfirmacao(`Excluir esta parcela?\nParcela ${despesa.parcela_atual} de ${despesa.total_parcelas}`, [
                        { texto: 'Somente esta', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'somente-esta' },
                        { texto: 'Todas', classe: 'btn-confirmar', cor: '#f39c12', valor: 'todas' },
                        { texto: 'Cancelar', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'somente-esta' || opcao === 'todas') {
                            excluirDoBackend(id, opcao);
                        }
                    });
                } else {
                    // N√£o √© parcelada, confirma√ß√£o simples
                    mostrarModalConfirmacao('Excluir esta despesa?', [
                        { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                        { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'excluir') {
                            excluirDoBackend(id);
                        }
                    });
                }
            } catch (erro) {
                console.error('Erro ao verificar despesa:', erro);
                // Caso n√£o consigamos verificar, mostrar confirma√ß√£o simples
                mostrarModalConfirmacao('Excluir esta despesa?', [
                    { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                    { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                ], (opcao) => {
                    if (opcao === 'excluir') {
                        excluirDoBackend(id);
                    }
                });
            }
        };

        // Fun√ß√£o auxiliar para obter despesas atuais
        async function obterDespesas() {
            try {
                const response = await fetch(`/api/despesas?mes=${mesAtual}&ano=${anoAtual}`);
                return await response.json();
            } catch (erro) {
                console.error('Erro ao obter despesas:', erro);
                return [];
            }
        }

        async function excluirDoBackend(id, tipoExclusao = 'excluir') {
            try {
                let url = `/api/despesas/${id}`;
                if (tipoExclusao !== 'excluir') {
                    // Adiciona par√¢metro para indicar o tipo de exclus√£o
                    url += `?tipoExclusao=${tipoExclusao}`;
                }

                await fetch(url, {
                    method: 'DELETE'
                });

                carregarDespesas();
            } catch (erro) {
                console.error('Erro ao excluir despesa:', erro);
                alert('Erro ao excluir despesa');
            }
        }

        document.getElementById('btnLogout').addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
            }
        });

        document.getElementById('btnMesAnterior').addEventListener('click', () => {
            console.log('M√™s anterior clicado');
            mesAnterior();
        });

        document.getElementById('btnMesProximo').addEventListener('click', () => {
            console.log('Pr√≥ximo m√™s clicado');
            mesProximo();
        });

        async function inicializar() {
            const autenticado = await verificarSessao();
            if (autenticado) {
                atualizarDisplay();
                carregarDespesas();
            }
        }

        inicializar();
    </script>
    <script src="/js/prevenir-zoom.js"></script>
</body>

</html>