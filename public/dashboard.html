<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dashboard - Sistema de Despesas</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" href="/img/familia.jpg">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üí∞ Minhas Despesas</h1>
                <button class="btn-config" id="btnConfig" title="Configura√ß√µes">‚öôÔ∏è</button>
            </div>
            <div class="user-info">
                <span class="user-name" id="nomeUsuario"></span>
                <button class="btn-logout" id="btnLogout">Sair</button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card total">
                <h3>Total</h3>
                <div class="value" id="totalMes">R$ 0</div>
            </div>
            <div class="stat-card pagas">
                <h3>Pagas</h3>
                <div class="value" id="totalPagas">R$ 0</div>
            </div>
            <div class="stat-card pendentes">
                <h3>Pendentes</h3>
                <div class="value" id="totalPendentes">R$ 0</div>
            </div>
        </div>

        <div class="month-navigation">
            <button class="btn-nav" id="btnMesAnterior">‚Üê</button>
            <div class="month-display" id="mesAnoDisplay">Dezembro 2024</div>
            <button class="btn-nav" id="btnMesAtual">‚óè</button>
            <button class="btn-nav" id="btnMesProximo">‚Üí</button>
        </div>

        <div class="despesas-container">
            <div id="listaDespesas">
                <div class="loading">Carregando</div>
            </div>
        </div>

        <!-- Bot√£o Flutuante -->
        <a href="/nova-despesa.html" class="fab">+</a>
    </div>

    <script>
        let usuarioAtual = null;
        let mesAtual = new Date().getMonth() + 1;
        let anoAtual = new Date().getFullYear();

        const mesesNomes = [
            'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        async function verificarSessao() {
            try {
                const response = await fetch('/api/auth/verificar-sessao', {
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (!data.autenticado) {
                    window.location.href = '/login.html';
                    return false;
                }

                usuarioAtual = data.usuario;
                document.getElementById('nomeUsuario').textContent = data.usuario.nome;
                return true;
            } catch (erro) {
                window.location.href = '/login.html';
                return false;
            }
        }

        function atualizarDisplay() {
            document.getElementById('mesAnoDisplay').textContent =
                `${mesesNomes[mesAtual - 1]} ${anoAtual}`;
        }

        function mesAnterior() {
            mesAtual--;
            if (mesAtual < 1) {
                mesAtual = 12;
                anoAtual--;
            }
            atualizarDisplay();
            carregarDespesas();
        }

        function mesProximo() {
            mesAtual++;
            if (mesAtual > 12) {
                mesAtual = 1;
                anoAtual++;
            }
            atualizarDisplay();
            carregarDespesas();
        }

        function voltarAoMesAtual() {
            const dataAtual = new Date();
            mesAtual = dataAtual.getMonth() + 1;
            anoAtual = dataAtual.getFullYear();
            atualizarDisplay();
            carregarDespesas();
        }

        async function carregarDespesas() {
            try {
                const response = await fetch(`/api/despesas?mes=${mesAtual}&ano=${anoAtual}`, {
                    credentials: 'same-origin'
                });
                
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const despesas = await response.json();

                exibirDespesas(despesas);
                calcularTotais(despesas);
            } catch (erro) {
                console.error('Erro ao carregar despesas:', erro);
                document.getElementById('listaDespesas').innerHTML =
                    '<div class="empty-state">‚ùå Erro ao carregar</div>';
            }
        }

        function exibirDespesas(despesas) {
            const container = document.getElementById('listaDespesas');

            if (despesas.length === 0) {
                container.innerHTML =
                    '<div class="empty-state">‚ú® Nenhuma despesa</div>';
                return;
            }

            // Separar despesas em pagas e pendentes
            const despesasPagas = despesas.filter(d => d.paga === true || d.paga === 'true' || d.paga === 1);
            const despesasPendentes = despesas.filter(d => d.paga !== true && d.paga !== 'true' && d.paga !== 1);

            let html = '';

            // Exibir se√ß√£o de despesas pendentes se houver
            if (despesasPendentes.length > 0) {
                html += '<div class="despesas-section"><h3 class="section-title">üí≥ Pendentes</h3>';
                html += despesasPendentes.map(despesa => {
                    // Tratar a data corretamente
                    let data;
                    if (despesa.data_vencimento) {
                        // Se vier como "2024-12-13T00:00:00.000Z" ou "2024-12-13"
                        data = new Date(despesa.data_vencimento);

                        // Se a data for inv√°lida, tentar outro formato
                        if (isNaN(data.getTime())) {
                            data = new Date(despesa.data_vencimento + 'T00:00:00');
                        }
                    } else {
                        data = new Date();
                    }

                    const dia = data.getDate().toString().padStart(2, '0');
                    const mes = (data.getMonth() + 1).toString().padStart(2, '0');

                    // Converter valor para n√∫mero
                    const valor = parseFloat(despesa.valor) || 0;

                    // Cor da categoria com fallback
                    const categoriaCor = despesa.categoria_cor || '#95a5a6';
                    const categoriaNome = despesa.categoria_nome || 'Sem categoria';

                    let detalhes = `<span class="categoria-badge" style="background-color: ${categoriaCor}">${categoriaNome}</span>`;
                    detalhes += ` <span>${dia}/${mes}</span>`;

                    if (despesa.tipo === 'fixa') {
                        detalhes += ` ‚Ä¢ Fixa`;
                    }

                    if (despesa.dividida) {
                        detalhes += ` ‚Ä¢ √∑2`;
                    }

                    return `
                        <div class="despesa-item ${despesa.paga ? 'paga' : ''}">
                            <input type="checkbox" class="checkbox-paga"
                                   ${despesa.paga ? 'checked' : ''}
                                   onchange="window.alterarStatusPagamento('${despesa.id}', this.checked)">
                            <div class="despesa-info">
                                <div class="despesa-descricao">${despesa.descricao}</div>
                                <div class="despesa-detalhes">${detalhes}</div>
                            </div>
                            <div class="despesa-valor">R$ ${valor.toFixed(2)}</div>
                            <div class="despesa-actions">
                                <button class="btn-editar" onclick="window.mostrarModalEditarDespesa('${despesa.id}')" title="Editar">‚úèÔ∏è</button>
                                <button class="btn-excluir" onclick="window.excluirDespesa('${despesa.id}')">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }

            // Exibir se√ß√£o de despesas pagas se houver
            if (despesasPagas.length > 0) {
                html += '<div class="despesas-section"><h3 class="section-title">‚úÖ Pagas</h3>';
                html += despesasPagas.map(despesa => {
                    // Tratar a data corretamente
                    let data;
                    if (despesa.data_vencimento) {
                        // Se vier como "2024-12-13T00:00:00.000Z" ou "2024-12-13"
                        data = new Date(despesa.data_vencimento);

                        // Se a data for inv√°lida, tentar outro formato
                        if (isNaN(data.getTime())) {
                            data = new Date(despesa.data_vencimento + 'T00:00:00');
                        }
                    } else {
                        data = new Date();
                    }

                    const dia = data.getDate().toString().padStart(2, '0');
                    const mes = (data.getMonth() + 1).toString().padStart(2, '0');

                    // Converter valor para n√∫mero
                    const valor = parseFloat(despesa.valor) || 0;

                    // Cor da categoria com fallback
                    const categoriaCor = despesa.categoria_cor || '#95a5a6';
                    const categoriaNome = despesa.categoria_nome || 'Sem categoria';

                    let detalhes = `<span class="categoria-badge" style="background-color: ${categoriaCor}">${categoriaNome}</span>`;
                    detalhes += ` <span>${dia}/${mes}</span>`;

                    if (despesa.tipo === 'fixa') {
                        detalhes += ` ‚Ä¢ Fixa`;
                    }

                    if (despesa.dividida) {
                        detalhes += ` ‚Ä¢ √∑2`;
                    }

                    return `
                        <div class="despesa-item ${despesa.paga ? 'paga' : ''}">
                            <input type="checkbox" class="checkbox-paga"
                                   ${despesa.paga ? 'checked' : ''}
                                   onchange="window.alterarStatusPagamento('${despesa.id}', this.checked)">
                            <div class="despesa-info">
                                <div class="despesa-descricao">${despesa.descricao}</div>
                                <div class="despesa-detalhes">${detalhes}</div>
                            </div>
                            <div class="despesa-valor">R$ ${valor.toFixed(2)}</div>
                            <div class="despesa-actions">
                                <button class="btn-editar" onclick="window.mostrarModalEditarDespesa('${despesa.id}')" title="Editar">‚úèÔ∏è</button>
                                <button class="btn-excluir" onclick="window.excluirDespesa('${despesa.id}')">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');
                html += '</div>';
            }

            // Se n√£o houver nenhuma despesa em nenhuma das categorias
            if (despesasPendentes.length === 0 && despesasPagas.length === 0) {
                html = '<div class="empty-state">‚ú® Nenhuma despesa</div>';
            }

            container.innerHTML = html;
        }

        function calcularTotais(despesas) {
            const total = despesas.reduce((sum, d) => sum + parseFloat(d.valor), 0);
            const pagas = despesas.filter(d => d.paga).reduce((sum, d) => sum + parseFloat(d.valor), 0);
            const pendentes = total - pagas;

            document.getElementById('totalMes').textContent =
                `R$ ${total.toFixed(2)}`;
            document.getElementById('totalPagas').textContent =
                `R$ ${pagas.toFixed(2)}`;
            document.getElementById('totalPendentes').textContent =
                `R$ ${pendentes.toFixed(2)}`;
        }

        window.alterarStatusPagamento = async function (id, paga) {
            try {
                // Verificar se √© uma despesa fixa para enviar os par√¢metros corretos
                const requestData = { paga };

                if (typeof id === 'string' && id.startsWith('fixa-')) {
                    // Para despesas fixas, precisamos enviar m√™s e ano
                    requestData.mes = mesAtual;
                    requestData.ano = anoAtual;
                }

                const response = await fetch(`/api/despesas/${id}/pagar`, {
                    method: 'PATCH',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }

                carregarDespesas();
            } catch (erro) {
                console.error('Erro ao atualizar despesa:', erro);
                mostrarModalAlerta('Erro ao atualizar despesa', 'erro');
            }
        };

        // Vari√°veis para controle de exclus√£o
        let despesaParaExcluir = null;

        // Fun√ß√£o para mostrar o modal de confirma√ß√£o
        function mostrarModalConfirmacao(mensagem, botoes, callback) {
            // Criar overlay escuro
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Criar conte√∫do do modal
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                max-width: 90%;
                width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;

            // Adicionar mensagem
            const mensagemElement = document.createElement('p');
            mensagemElement.textContent = mensagem;
            mensagemElement.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 16px;
                color: #333;
            `;

            // Criar bot√µes
            const botoesDiv = document.createElement('div');
            botoesDiv.style.cssText = `
                display: flex;
                justify-content: space-around;
                gap: 10px;
            `;

            // Adicionar bot√µes dinamicamente
            botoes.forEach(botao => {
                const btn = document.createElement('button');
                btn.textContent = botao.texto;
                btn.className = botao.classe;
                btn.style.cssText = `
                    background: ${botao.cor};
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    flex: 1;
                `;

                btn.addEventListener('click', () => {
                    callback(botao.valor);
                    document.body.removeChild(overlay);
                });

                botoesDiv.appendChild(btn);
            });

            // Adicionar elementos ao modal
            modalContent.appendChild(mensagemElement);
            modalContent.appendChild(botoesDiv);
            overlay.appendChild(modalContent);

            // Adicionar overlay ao body
            document.body.appendChild(overlay);
        }

        // Fun√ß√£o para mostrar modal de alerta
        function mostrarModalAlerta(mensagem, tipo = 'info', callback = null) {
            // Criar overlay escuro
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Criar conte√∫do do modal
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                max-width: 90%;
                width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;

            // Adicionar mensagem
            const mensagemElement = document.createElement('p');
            mensagemElement.textContent = mensagem;
            mensagemElement.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 16px;
                color: #333;
            `;

            // Determinar cor do bot√£o baseado no tipo
            let corBotao = '#3498db'; // Padr√£o (info)
            if (tipo === 'erro') {
                corBotao = '#e74c3c';
            } else if (tipo === 'sucesso') {
                corBotao = '#2ecc71';
            }

            // Criar bot√£o de confirma√ß√£o
            const btn = document.createElement('button');
            btn.textContent = 'OK';
            btn.className = 'btn-confirmar';
            btn.style.cssText = `
                background: ${corBotao};
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                width: 100%;
            `;

            btn.addEventListener('click', () => {
                if (callback) callback();
                document.body.removeChild(overlay);
            });

            // Adicionar elementos ao modal
            modalContent.appendChild(mensagemElement);
            modalContent.appendChild(btn);
            overlay.appendChild(modalContent);

            // Adicionar overlay ao body
            document.body.appendChild(overlay);
        }

        window.excluirDespesa = async function (id) {
            // Primeiro, obter informa√ß√µes da despesa para verificar se √© parcelada
            try {
                // Para despesas fixas, n√£o precisamos verificar parcelamento
                if (typeof id === 'string' && id.startsWith('fixa-')) {
                    mostrarModalConfirmacao('Excluir esta despesa fixa?', [
                        { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                        { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'excluir') {
                            excluirDoBackend(id);
                        }
                    });
                    return;
                }

                // Para despesas normais, verificar se √© parcelada
                const despesas = await obterDespesas(); // Obter lista atualizada
                const despesa = despesas.find(d => d.id == id);

                if (despesa && despesa.grupo_parcelamento && despesa.total_parcelas && despesa.total_parcelas > 1) {
                    // √â uma despesa parcelada
                    mostrarModalConfirmacao(`Excluir esta parcela?\nParcela ${despesa.parcela_atual} de ${despesa.total_parcelas}`, [
                        { texto: 'Somente esta', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'somente-esta' },
                        { texto: 'Todas', classe: 'btn-confirmar', cor: '#f39c12', valor: 'todas' },
                        { texto: 'Cancelar', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'somente-esta' || opcao === 'todas') {
                            excluirDoBackend(id, opcao);
                        }
                    });
                } else {
                    // N√£o √© parcelada, confirma√ß√£o simples
                    mostrarModalConfirmacao('Excluir esta despesa?', [
                        { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                        { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                    ], (opcao) => {
                        if (opcao === 'excluir') {
                            excluirDoBackend(id);
                        }
                    });
                }
            } catch (erro) {
                console.error('Erro ao verificar despesa:', erro);
                // Caso n√£o consigamos verificar, mostrar confirma√ß√£o simples
                mostrarModalConfirmacao('Excluir esta despesa?', [
                    { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: 'excluir' },
                    { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: 'cancelar' }
                ], (opcao) => {
                    if (opcao === 'excluir') {
                        excluirDoBackend(id);
                    }
                });
            }
        };

        // Fun√ß√£o auxiliar para obter despesas atuais
        async function obterDespesas() {
            try {
                const response = await fetch(`/api/despesas?mes=${mesAtual}&ano=${anoAtual}`, {
                    credentials: 'same-origin'
                });
                return await response.json();
            } catch (erro) {
                console.error('Erro ao obter despesas:', erro);
                return [];
            }
        }

        async function excluirDoBackend(id, tipoExclusao = 'excluir') {
            try {
                let url = `/api/despesas/${id}`;
                if (tipoExclusao !== 'excluir') {
                    url += `?tipoExclusao=${tipoExclusao}`;
                }

                const response = await fetch(url, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    carregarDespesas();
                } else if (response.status === 401) {
                    window.location.href = '/login.html';
                } else {
                    const errorData = await response.json();
                    mostrarModalAlerta(errorData.erro || 'Erro ao excluir despesa', 'erro');
                }
            } catch (erro) {
                console.error('Erro ao excluir despesa:', erro);
                mostrarModalAlerta('Erro ao excluir despesa', 'erro');
            }
        }

        // Fun√ß√£o para mostrar modal de edi√ß√£o de despesa
        window.mostrarModalEditarDespesa = async function(id) {
            try {
                // Obter todas as despesas para encontrar a que est√° sendo editada
                const despesas = await obterDespesas();
                const despesa = despesas.find(d => d.id == id || `fixa-${d.id}` == id);

                if (!despesa) {
                    mostrarModalAlerta('Despesa n√£o encontrada', 'erro');
                    return;
                }

                // Carregar categorias para o select
                const categorias = await carregarCategorias();
                const usuarios = await carregarUsuarios();

                // Criar overlay
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                // Criar conte√∫do do modal
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 90%;
                    width: 400px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                `;

                // Cabe√ßalho
                const header = document.createElement('div');
                header.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 15px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid #ecf0f1;
                `;

                const titulo = document.createElement('h3');
                titulo.textContent = '‚úèÔ∏è Editar Despesa';
                titulo.style.cssText = `margin: 0; color: #2c3e50; font-size: 18px;`;

                const btnFechar = document.createElement('button');
                btnFechar.innerHTML = '‚úï';
                btnFechar.style.cssText = `
                    background: transparent;
                    color: #95a5a6;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0;
                `;

                header.appendChild(titulo);
                header.appendChild(btnFechar);
                modalContent.appendChild(header);

                // Formul√°rio
                const form = document.createElement('form');
                form.style.cssText = `display: flex; flex-direction: column; gap: 15px;`;

                // Descri√ß√£o
                form.innerHTML += `
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 14px;">Descri√ß√£o</label>
                        <input type="text" id="editDescricao" value="${despesa.descricao}" required style="
                            width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-size: 14px; box-sizing: border-box;
                        ">
                    </div>
                `;

                // Valor
                const valorOriginal = despesa.dividida ? parseFloat(despesa.valor) * 2 : parseFloat(despesa.valor);
                form.innerHTML += `
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 14px;">Valor (R$)</label>
                        <input type="number" id="editValor" value="${valorOriginal.toFixed(2)}" step="0.01" min="0" required style="
                            width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-size: 14px; box-sizing: border-box;
                        ">
                    </div>
                `;

                // Categoria
                const categoriasOptions = categorias.map(cat => 
                    `<option value="${cat.id}" ${cat.id === despesa.categoria_id ? 'selected' : ''}>${cat.nome}</option>`
                ).join('');
                form.innerHTML += `
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 14px;">Categoria</label>
                        <select id="editCategoria" style="
                            width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-size: 14px; box-sizing: border-box;
                        ">${categoriasOptions}</select>
                    </div>
                `;

                // Data de vencimento
                const dataVencimento = despesa.data_vencimento ? despesa.data_vencimento.split('T')[0] : new Date().toISOString().split('T')[0];
                form.innerHTML += `
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 14px;">Data de Vencimento</label>
                        <input type="date" id="editDataVencimento" value="${dataVencimento}" required style="
                            width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-size: 14px; box-sizing: border-box;
                        ">
                    </div>
                `;

                // Checkbox Dividir
                const usuariosOptions = usuarios.map(u => 
                    `<option value="${u.id}" ${u.id === despesa.usuario_compartilhado_id ? 'selected' : ''}>${u.nome}</option>`
                ).join('');
                form.innerHTML += `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="editDividir" ${despesa.dividida ? 'checked' : ''} style="width: 18px; height: 18px;">
                        <label for="editDividir" style="color: #2c3e50; font-size: 14px;">Dividir despesa com outro usu√°rio</label>
                    </div>
                `;

                // Select Usu√°rio (aparece apenas se dividir estiver marcado)
                form.innerHTML += `
                    <div id="editUsuarioCompartilhadoDiv" style="display: ${despesa.usuario_compartilhado_id ? 'block' : 'none'};">
                        <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 14px;">Compartilhar com:</label>
                        <select id="editUsuarioCompartilhado" style="
                            width: 100%; padding: 10px; border: 1px solid #ecf0f1; border-radius: 5px; font-size: 14px; box-sizing: border-box;
                        ">
                            <option value="">Selecione um usu√°rio...</option>
                            ${usuariosOptions}
                        </select>
                    </div>
                `;

                // Bot√µes
                const botoesDiv = document.createElement('div');
                botoesDiv.style.cssText = `
                    display: flex;
                    gap: 10px;
                    margin-top: 10px;
                `;

                const btnCancelar = document.createElement('button');
                btnCancelar.textContent = 'Cancelar';
                btnCancelar.type = 'button';
                btnCancelar.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #95a5a6;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    font-size: 14px;
                    cursor: pointer;
                    font-weight: 600;
                `;

                const btnSalvar = document.createElement('button');
                btnSalvar.textContent = 'Salvar Altera√ß√µes';
                btnSalvar.type = 'submit';
                btnSalvar.style.cssText = `
                    flex: 1;
                    padding: 12px;
                    background: #27ae60;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    font-size: 14px;
                    cursor: pointer;
                    font-weight: 600;
                `;

                botoesDiv.appendChild(btnCancelar);
                botoesDiv.appendChild(btnSalvar);
                form.appendChild(botoesDiv);
                modalContent.appendChild(form);
                overlay.appendChild(modalContent);
                document.body.appendChild(overlay);

                // Toggle do campo de usu√°rio compartilhado
                const checkboxDividir = document.getElementById('editDividir');
                const usuarioCompartilhadoDiv = document.getElementById('editUsuarioCompartilhadoDiv');
                checkboxDividir.addEventListener('change', () => {
                    usuarioCompartilhadoDiv.style.display = checkboxDividir.checked ? 'block' : 'none';
                });

                // Fechar modal
                btnFechar.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                });

                btnCancelar.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                // Submit do formul√°rio
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const dadosAtualizacao = {
                        descricao: document.getElementById('editDescricao').value,
                        valor: document.getElementById('editValor').value,
                        categoria_id: parseInt(document.getElementById('editCategoria').value),
                        data_vencimento: document.getElementById('editDataVencimento').value,
                        dividir: checkboxDividir.checked
                    };

                    if (checkboxDividir.checked) {
                        dadosAtualizacao.usuario_compartilhado_id = parseInt(document.getElementById('editUsuarioCompartilhado').value);
                        if (!dadosAtualizacao.usuario_compartilhado_id) {
                            mostrarModalAlerta('Selecione um usu√°rio para compartilhar', 'erro');
                            return;
                        }
                    }

                    // Se for despesa fixa, enviar m√™s e ano tamb√©m
                    if (typeof id === 'string' && id.startsWith('fixa-')) {
                        dadosAtualizacao.mes = mesAtual;
                        dadosAtualizacao.ano = anoAtual;
                    }

                    try {
                        const response = await fetch(`/api/despesas/${id}`, {
                            method: 'PUT',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dadosAtualizacao)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            document.body.removeChild(overlay);
                            carregarDespesas();
                            mostrarModalAlerta('Despesa editada com sucesso!', 'sucesso');
                        } else if (response.status === 401) {
                            window.location.href = '/login.html';
                        } else {
                            mostrarModalAlerta('Erro ao editar despesa: ' + (result.erro || result.detalhe), 'erro');
                        }
                    } catch (erro) {
                        console.error('Erro ao editar despesa:', erro);
                        mostrarModalAlerta('Erro ao editar despesa', 'erro');
                    }
                });

            } catch (erro) {
                console.error('Erro ao carregar dados para edi√ß√£o:', erro);
                mostrarModalAlerta('Erro ao carregar dados para edi√ß√£o', 'erro');
            }
        };

        // Fun√ß√£o auxiliar para carregar usu√°rios
        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/despesas/usuarios', {
                    credentials: 'same-origin'
                });
                return await response.json();
            } catch (erro) {
                console.error('Erro ao carregar usu√°rios:', erro);
                return [];
            }
        }

        document.getElementById('btnLogout').addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                window.location.href = '/login.html';
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
            }
        });

        document.getElementById('btnMesAnterior').addEventListener('click', () => {
            mesAnterior();
        });

        document.getElementById('btnMesProximo').addEventListener('click', () => {
            mesProximo();
        });

        document.getElementById('btnMesAtual').addEventListener('click', () => {
            voltarAoMesAtual();
        });

        // Evento para o bot√£o de configura√ß√µes
        document.getElementById('btnConfig').addEventListener('click', () => {
            mostrarModalConfiguracoes();
        });

        async function inicializar() {
            const autenticado = await verificarSessao();
            if (autenticado) {
                atualizarDisplay();
                carregarDespesas();
            }
        }

        // Fun√ß√µes para gerenciamento de categorias
        async function mostrarModalConfiguracoes() {
            // Primeiro, carregar as categorias existentes
            const categorias = await carregarCategorias();

            // Criar overlay escuro
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            // Criar conte√∫do do modal
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-config';
            modalContent.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 90%;
                width: 350px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            `;

            // Cabe√ßalho do modal (t√≠tulo e bot√£o de fechar)
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--light);
            `;

            const titulo = document.createElement('h3');
            titulo.textContent = '‚öôÔ∏è Configura√ß√µes';
            titulo.style.cssText = `
                margin: 0;
                color: var(--dark);
                font-size: 18px;
            `;

            // Bot√£o de fechar
            const btnFechar = document.createElement('button');
            btnFechar.innerHTML = '‚úï';
            btnFechar.style.cssText = `
                background: transparent;
                color: var(--gray);
                border: none;
                font-size: 20px;
                cursor: pointer;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                margin: 0;
            `;

            header.appendChild(titulo);
            header.appendChild(btnFechar);
            modalContent.appendChild(header);

            // Bot√£o Gerenciar Usu√°rios
            const btnGerenciarUsuarios = document.createElement('button');
            btnGerenciarUsuarios.textContent = 'üë• Gerenciar Usu√°rios';
            btnGerenciarUsuarios.style.cssText = `
                width: 100%;
                padding: 12px;
                margin-bottom: 15px;
                background: var(--primary-color);
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 14px;
                cursor: pointer;
                text-align: left;
            `;
            btnGerenciarUsuarios.onmouseover = () => btnGerenciarUsuarios.style.background = 'var(--primary-dark)';
            btnGerenciarUsuarios.onmouseout = () => btnGerenciarUsuarios.style.background = 'var(--primary-color)';
            btnGerenciarUsuarios.onclick = () => {
                window.location.href = '/gerenciar-usuarios.html';
            };
            modalContent.appendChild(btnGerenciarUsuarios);

            // Se√ß√£o de cadastro de categorias
            const secaoCadastro = document.createElement('div');
            secaoCadastro.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h4 style="color: var(--dark); margin: 0 0 10px 0; font-size: 14px;">Nova Categoria</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="novaCategoriaNome" placeholder="Nome da categoria" style="
                            padding: 10px;
                            border: 1px solid var(--light);
                            border-radius: 5px;
                            font-size: 14px;
                        ">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label for="novaCategoriaCor" style="font-size: 12px; color: var(--dark); white-space: nowrap;">Cor:</label>
                            <input type="color" id="novaCategoriaCor" value="#3498db" style="
                                width: 40px;
                                height: 40px;
                                border: none;
                                cursor: pointer;
                            ">
                            <span id="corPreview" style="
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                background-color: #3498db;
                                border-radius: 3px;
                                border: 1px solid var(--gray);
                            "></span>
                        </div>
                        <button id="btnAdicionarCategoria" class="btn-success" style="
                            padding: 10px;
                            border: none;
                            border-radius: 5px;
                            color: white;
                            font-weight: 600;
                            cursor: pointer;
                        ">Adicionar Categoria</button>
                    </div>
                </div>
            `;

            // Se√ß√£o de lista de categorias
            const secaoLista = document.createElement('div');
            secaoLista.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <h4 style="color: var(--dark); margin: 0 0 10px 0; font-size: 14px;">Categorias Cadastradas</h4>
                    <div id="listaCategorias" style="margin-top: 10px;">
                        ${gerarHTMLCategorias(categorias)}
                    </div>
                </div>
            `;

            // Adicionar elementos ao modal
            modalContent.appendChild(secaoCadastro);
            modalContent.appendChild(secaoLista);
            overlay.appendChild(modalContent);

            // Adicionar overlay ao body
            document.body.appendChild(overlay);

            // Evento para atualizar preview da cor
            const corInput = document.getElementById('novaCategoriaCor');
            const preview = document.getElementById('corPreview');
            corInput.addEventListener('input', (e) => {
                preview.style.backgroundColor = e.target.value;
            });

            // Evento para adicionar nova categoria
            document.getElementById('btnAdicionarCategoria').addEventListener('click', async () => {
                const nome = document.getElementById('novaCategoriaNome').value.trim();
                const cor = document.getElementById('novaCategoriaCor').value;

                if (!nome) {
                    mostrarModalAlerta('Por favor, informe o nome da categoria', 'erro');
                    return;
                }

                try {
                    const response = await fetch('/api/despesas/categorias', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ nome, cor })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('novaCategoriaNome').value = '';
                        // Recarregar a lista de categorias
                        const categoriasAtualizadas = await carregarCategorias();
                        document.getElementById('listaCategorias').innerHTML = gerarHTMLCategorias(categoriasAtualizadas);
                        mostrarModalAlerta('Categoria adicionada com sucesso!', 'sucesso');
                    } else if (response.status === 401) {
                        window.location.href = '/login.html';
                    } else {
                        mostrarModalAlerta('Erro ao adicionar categoria: ' + result.erro, 'erro');
                    }
                } catch (erro) {
                    console.error('Erro ao adicionar categoria:', erro);
                    mostrarModalAlerta('Erro ao adicionar categoria', 'erro');
                }
            });

            // Evento para excluir categoria (usando event delegation)
            modalContent.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-excluir-categoria')) {
                    const categoriaId = e.target.dataset.id;
                    const categoriaNome = e.target.dataset.nome;

                    mostrarModalConfirmacao(`Excluir a categoria "${categoriaNome}"?`, [
                        { texto: 'Sim', classe: 'btn-confirmar', cor: '#e74c3c', valor: true },
                        { texto: 'N√£o', classe: 'btn-cancelar', cor: '#95a5a6', valor: false }
                    ], (confirmado) => {
                        if (confirmado) {
                            excluirCategoria(categoriaId);
                        }
                    });
                }
            });

            // Fun√ß√£o auxiliar para excluir categoria
            async function excluirCategoria(id) {
                try {
                    const response = await fetch(`/api/despesas/categorias/${id}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Recarregar a lista de categorias
                        const categoriasAtualizadas = await carregarCategorias();
                        document.getElementById('listaCategorias').innerHTML = gerarHTMLCategorias(categoriasAtualizadas);
                        mostrarModalAlerta('Categoria exclu√≠da com sucesso!', 'sucesso');
                    } else if (response.status === 401) {
                        window.location.href = '/login.html';
                    } else {
                        mostrarModalAlerta('Erro ao excluir categoria: ' + result.erro, 'erro');
                    }
                } catch (erro) {
                    console.error('Erro ao excluir categoria:', erro);
                    mostrarModalAlerta('Erro ao excluir categoria', 'erro');
                }
            }

            // Evento para fechar o modal
            btnFechar.addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            // Fechar modal ao clicar fora
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }

        async function carregarCategorias() {
            try {
                const response = await fetch('/api/despesas/categorias', {
                    credentials: 'same-origin'
                });
                return await response.json();
            } catch (erro) {
                console.error('Erro ao carregar categorias:', erro);
                return [];
            }
        }

        function gerarHTMLCategorias(categorias) {
            if (categorias.length === 0) {
                return '<p style="text-align: center; color: var(--gray); font-style: italic; margin: 10px 0;">Nenhuma categoria cadastrada</p>';
            }

            return categorias.map(cat => `
                <div class="categoria-item" style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px;
                    border: 1px solid var(--light);
                    border-radius: 5px;
                    margin-bottom: 5px;
                    background: #f8f9fa;
                ">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="
                            display: inline-block;
                            width: 15px;
                            height: 15px;
                            background-color: ${cat.cor};
                            border-radius: 3px;
                            border: 1px solid var(--gray);
                        "></span>
                        <span style="font-size: 14px; color: var(--dark);">${cat.nome}</span>
                    </div>
                    <button class="btn-excluir-categoria" data-id="${cat.id}" data-nome="${cat.nome}" style="
                        background: var(--danger);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        padding: 5px 10px;
                        cursor: pointer;
                        font-size: 12px;
                    ">Excluir</button>
                </div>
            `).join('');
        }

        inicializar();
    </script>
    <footer style="text-align: center; padding: 10px; color: #7f8c8d; font-size: 12px; margin-top: 20px;">
        Criado por Thiago Alves Nunes
    </footer>
    <script src="/js/particles.js"></script>
    <script src="/js/prevenir-zoom.js"></script>
</body>

</html>